<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <title>神魔圖鑒</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: flex-start;
      flex-direction: column;
      height: 100vh;
    }
    .gallery {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 10px;
      justify-items: center;
      width: 100%;
      max-width: 1200px;
      margin-top: 80px;
    }
    .monster {
      width: 142px;
      text-align: center;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ccc;
    }
    .monster img {
      width: 80px;
      height: 80px;
      object-fit: contain;
      display: block;
      margin: 0 auto 8px;
    }
    .monster-info {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      font-size: 14px;
      margin-top: 6px;
      color: #444;
    }
    .monster.show-info .monster-info {
      max-height: 150px;
    }
    .search-bar-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 999;
      display: flex;
      align-items: center;
      padding: 0 10px;
    }
    .search-bar {
      width: 25%;
      background: #fff;
      padding: 10px 20px;
      box-sizing: border-box;
      border-radius: 6px;
      position: relative;
      z-index: 1000;
    }
    .search-bar input {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .dropdown {
      position: relative;
      margin-left: 10px;
    }
    .dropdown-button {
      background: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      font-size: 14px;
      cursor: pointer;
      transition: border-color 0.3s;
    }
    .dropdown-button:hover {
      border-color: #888;
    }
    .dropdown-button img {
      width: 24px;
      height: 24px;
      margin-right: 8px;
    }
    .selected-icons img {
      width: 20px;
      height: 20px;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background-color: #fff;
      border: 1px solid #ccc;
      box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 1;
      min-width: max-content;
      padding: 4px 0;
      border-radius: 6px;
    }
    .dropdown-content.show {
      display: block;
    }
    .dropdown-item {
      padding: 6px 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    .dropdown-item:hover {
      background-color: #f0f0f0;
    }
    .dropdown-item img {
      width: 24px;
      height: 24px;
      margin-right: 10px;
    }
    .dropdown-item.selected {
      opacity: 0.4;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="search-bar-wrapper">
    <div class="search-bar">
      <input id="searchInput" onkeyup="filterMonsters()" placeholder="搜尋怪物..." type="text"/>
    </div>
    <div class="dropdown" id="attributeDropdown">
      <div class="dropdown-button dropdown-trigger">
        <div class="selected-icons"></div>
        <span>屬性</span>
      </div>
      <div class="dropdown-content" id="attributeContent">
        <!-- 屬性選項 -->
      </div>
    </div>
    <div class="dropdown" id="raceDropdown">
      <div class="dropdown-button dropdown-trigger">
        <div class="selected-icons"></div>
        <span>種族</span>
      </div>
      <div class="dropdown-content" id="raceContent">
        <!-- 種族選項 -->
      </div>
    </div>
    <button id="resetFilters">
      <img src="reset-icon.png" alt="重設" />
    </button>
  </div>

  <div class="gallery" id="monsterGallery">
    <!-- 動態插入 monster cards -->
  </div>

<script>
let selectedAttributes = new Set();
let selectedRaces = new Set();
let monsterData = {};

// 自動加 .monster-info
const monsters = document.querySelectorAll('.monster');
monsters.forEach(monster => {
  if (!monster.querySelector('.monster-info')) {
    const infoDiv = document.createElement('div');
    infoDiv.classList.add('monster-info');
    monster.appendChild(infoDiv);
  }
});

// 載入 JSON
fetch('monster.json')
  .then(res => res.json())
  .then(data => {
    data.forEach(mon => {
      monsterData[mon.id] = mon;
    });
  });

// Dropdown toggle
document.querySelectorAll(".dropdown").forEach(dropdown => {
  const trigger = dropdown.querySelector(".dropdown-trigger");
  const content = dropdown.querySelector(".dropdown-content");

  trigger.addEventListener("click", () => {
    content.classList.toggle("show");
  });
});

document.addEventListener("click", function(event) {
  document.querySelectorAll(".dropdown-content").forEach(content => {
    if (!content.parentElement.contains(event.target)) {
      content.classList.remove("show");
    }
  });
});

function updateSelectedIcons(containerId, selectedSet) {
  const container = document.querySelector(`#${containerId} .selected-icons`);
  const items = document.querySelectorAll(`#${containerId} .dropdown-item`);
  const label = document.querySelector(`#${containerId} .dropdown-button span`);
  container.innerHTML = '';

  selectedSet.forEach(value => {
    items.forEach(item => {
      if (item.dataset.value === value) {
        const img = item.querySelector('img').cloneNode();
        img.style.width = '20px';
        img.style.height = '20px';
        container.appendChild(img);
      }
    });
  });

  label.style.display = selectedSet.size > 0 ? 'none' : 'inline';
}

document.getElementById("resetFilters").addEventListener("click", () => {
  selectedAttributes.clear();
  selectedRaces.clear();

  document.querySelectorAll('.dropdown-item.selected').forEach(item => {
    item.classList.remove('selected');
  });
  document.querySelectorAll('.selected-icons').forEach(iconBox => {
    iconBox.innerHTML = '';
  });
  document.getElementById("searchInput").value = '';
  updateSelectedIcons('attributeDropdown', selectedAttributes);
  updateSelectedIcons('raceDropdown', selectedRaces);
  filterMonsters();
});

document.querySelectorAll('#attributeContent .dropdown-item').forEach(item => {
  item.addEventListener('click', function () {
    const value = this.getAttribute('data-value');
    this.classList.toggle('selected');

    if (selectedAttributes.has(value)) {
      selectedAttributes.delete(value);
    } else {
      selectedAttributes.add(value);
    }
    updateSelectedIcons('attributeDropdown', selectedAttributes);
    filterMonsters();
  });
});

document.querySelectorAll('#raceContent .dropdown-item').forEach(item => {
  item.addEventListener('click', function () {
    const value = this.getAttribute('data-value');
    this.classList.toggle('selected');

    if (selectedRaces.has(value)) {
      selectedRaces.delete(value);
    } else {
      selectedRaces.add(value);
    }
    updateSelectedIcons('raceDropdown', selectedRaces);
    filterMonsters();
  });
});

function filterMonsters() {
  const searchTerm = document.getElementById("searchInput").value.trim().toLowerCase();
  const monsters = document.querySelectorAll(".monster");

  monsters.forEach(monster => {
    const name = monster.querySelector("div:nth-child(3)").textContent.toLowerCase();
    const id = monster.querySelector("div:nth-child(1)").textContent.toLowerCase();
    const attribute = monster.getAttribute('data-attribute');
    const race = monster.getAttribute('data-race');

    const matchesSearch = name.includes(searchTerm) || id.includes(searchTerm);
    const matchesAttribute = selectedAttributes.size === 0 || selectedAttributes.has(attribute);
    const matchesRace = selectedRaces.size === 0 || selectedRaces.has(race);

    monster.style.display = (matchesSearch && matchesAttribute && matchesRace) ? "block" : "none";
  });
}

document.querySelectorAll('.monster').forEach(monster => {
  monster.addEventListener('click', () => {
    document.querySelectorAll('.monster.show-info').forEach(m => {
      if (m !== monster) m.classList.remove('show-info');
    });

    const id = parseInt(monster.dataset.id);
    const infoBox = monster.querySelector('.monster-info');
    const data = monsterData[id];

    if (data && infoBox) {
      infoBox.innerHTML = `
        <div>HP：${data.HP}</div>
        <div>ATK：${data.ATK}</div>
        <div>REC：${data.REC}</div>
      `;
    } else {
      infoBox.innerHTML = '<div>找不到資料</div>';
    }

    monster.classList.toggle('show-info');
  });
});
</script>
</body>
</html>
